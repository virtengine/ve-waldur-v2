# Generated by Django 2.2.13 on 2020-09-22 20:36
import datetime

from django.contrib.contenttypes.models import ContentType
from django.db import migrations

from ..utils import get_offering_details


def init_invoice_items_details_from_order_item(apps, schema_editor):
    InvoiceItem = apps.get_model('invoices', 'InvoiceItem')
    OrderItem = apps.get_model('marketplace', 'OrderItem')
    ComponentUsage = apps.get_model('marketplace', 'ComponentUsage')
    Resource = apps.get_model('marketplace', 'Resource')

    details = {}

    class Types:
        CREATE = 1
        UPDATE = 2
        TERMINATE = 3

    class States:
        PENDING = 1
        EXECUTING = 2
        DONE = 3
        ERRED = 4
        TERMINATED = 5
        TERMINATING = 6

    for item in InvoiceItem.objects.filter(
        content_type_id=ContentType.objects.get_for_model(Resource).id
    ):
        order_item = (
            OrderItem.objects.filter(
                state=States.DONE,
                resource_id=item.object_id,
                order__approved_at__lte=datetime.datetime(
                    year=item.invoice.year, month=item.invoice.month, day=1
                ),
            )
            .exclude(type=Types.TERMINATE)
            .order_by('order__approved_at')
            .last()
        )

        if order_item:
            details.update(get_offering_details(order_item.offering))
            details['limits'] = order_item.limits

        details['usages'] = {}

        billing_period = datetime.date(
            year=item.invoice.year, month=item.invoice.month, day=1
        )

        usages = ComponentUsage.objects.filter(
            resource_id=item.object_id, billing_period=billing_period
        )

        for usage in usages:
            details['usages'][usage.component.type] = usage.usage

        if not order_item and len(usages):
            offering = usage.component.offering
            details.update(get_offering_details(offering))

        item.details.update(details)
        item.save()


class Migration(migrations.Migration):

    dependencies = [
        ('marketplace', '0023_category_i18n'),
        ('contenttypes', '0002_remove_content_type_name'),
        ('invoices', '0040_invoice_created'),
    ]

    operations = [
        migrations.RunPython(init_invoice_items_details_from_order_item),
    ]
