# Generated by Django 2.2.13 on 2020-10-08 10:10

from django.db import migrations


def rename_components(apps, schema_editor):
    OfferingComponent = apps.get_model('marketplace', 'OfferingComponent')
    OfferingComponent.objects.filter(
        offering__type='SlurmInvoices.SlurmPackage', name='RAM'
    ).update(measured_unit='GB-hours')


def fix_slurm_invoices(apps, schema_editor):
    InvoiceItem = apps.get_model('invoices', 'InvoiceItem')
    for inv_item in InvoiceItem.objects.filter(name__contains='(RAM)'):
        inv_item.quantity = int(inv_item.quantity / 60)
        inv_item.save()


def rename_slurm_invoice_items(apps, schema_editor):
    InvoiceItem = apps.get_model('invoices', 'InvoiceItem')
    for inv_item in InvoiceItem.objects.filter(name__contains='(RAM)'):
        inv_item.name = inv_item.name.replace('(RAM)', '(RAM GB-hours)')
        inv_item.save()
    for inv_item in InvoiceItem.objects.filter(name__contains='(CPU)'):
        inv_item.name = inv_item.name.replace('(CPU)', '(CPU-hours)')
        inv_item.save()
    for inv_item in InvoiceItem.objects.filter(name__contains='(GPU)'):
        inv_item.name = inv_item.name.replace('(GPU)', '(GPU-hours)')
        inv_item.save()


class Migration(migrations.Migration):

    dependencies = [
        ('marketplace', '0026_offeringcomponent_is_boolean'),
    ]

    operations = [
        migrations.RunPython(rename_components),
        migrations.RunPython(fix_slurm_invoices),
        migrations.RunPython(rename_slurm_invoice_items),
    ]
